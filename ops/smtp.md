# Өөрийн SMTP мэйл илгээх серверийг бүтээгээрэй

## оршил

SMTP нь үүлэн борлуулагчдаас шууд үйлчилгээг худалдан авах боломжтой, тухайлбал:

* [Amazon SES SMTP](https://docs.aws.amazon.com/ses/latest/dg/send-email-smtp.html)
* [Али үүлэн цахим шуудангийн түлхэлт](https://www.alibabacloud.com/help/directmail/latest/three-mail-sending-methods)

Та мөн өөрийн шуудангийн серверийг үүсгэж болно - хязгааргүй илгээлт, бага нийт зардал.

Доор бид өөрсдийн шуудангийн серверийг хэрхэн бүтээхийг алхам алхмаар харуулж байна.

## Серверийн сонголт

Өөрөө байршуулсан SMTP сервер нь нээлттэй 25, 456, 587 порттой нийтийн IP шаарддаг.

Түгээмэл хэрэглэгддэг нийтийн үүл нь эдгээр портуудыг өгөгдмөлөөр хаасан бөгөөд ажлын тушаал гаргаснаар тэдгээрийг нээх боломжтой байж болох ч энэ нь маш хэцүү байдаг.

Би эдгээр портууд нээлттэй, урвуу домэйн нэрийг тохируулахыг дэмждэг хостоос худалдаж авахыг зөвлөж байна.

Энд би [Contabo-г](https://contabo.com) санал болгож байна.

Contabo бол 2003 онд байгуулагдсан Германы Мюнхен хотод байрладаг хостинг үйлчилгээ үзүүлэгч юм.

Хэрэв та еврог худалдан авах валютаар сонговол үнэ нь хямд байх болно (8 ГБ санах ой, 4 CPU-тэй сервер нь жилд ойролцоогоор 529 юань, эхний суулгалтын төлбөр нь нэг жил үнэгүй).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/UoAQkwY.webp)

Захиалга хийхдээ `prefer AMD` анхаарна уу, AMD CPU-тэй сервер илүү сайн гүйцэтгэлтэй байх болно.

Дараах зүйлд би Контабогийн VPS-ийг жишээ болгон авч өөрийн шуудангийн серверийг хэрхэн бүтээхийг харуулах болно.

## Ubuntu системийн тохиргоо

Энд байгаа үйлдлийн систем нь Ubuntu 22.04 юм

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/smpIu1F.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/m7Mwjwr.webp)

Хэрэв ssh дээрх сервер `Welcome to TinyCore 13!` (доорх зурагт үзүүлсэн шиг) энэ нь системийг хараахан суулгаагүй гэсэн үг юм. ssh-г салгаад дахин нэвтрэхийн тулд хэдэн минут хүлээнэ үү.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/-qKACz9.webp)

`Welcome to Ubuntu 22.04.1 LTS` гарч ирэх үед эхлүүлэх ажиллагаа дууссан бөгөөд та дараах алхмуудыг үргэлжлүүлж болно.

### [Заавал биш] Хөгжлийн орчныг эхлүүлэх

Энэ алхам нь сонголттой.

Тохиромжтой болгох үүднээс би [github.com/wactax/ops.os/tree/main/ubuntu](https://github.com/wactax/ops.os/tree/main/ubuntu) дээр ubuntu програм хангамжийн суулгац болон системийн тохиргоог хийсэн.

Нэг товшилтоор суулгахын тулд дараах тушаалыг ажиллуулна уу.

```
bash <(curl -s https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

Хятад хэрэглэгчид та оронд нь дараах командыг ашиглана уу, хэл, цагийн бүс гэх мэтийг автоматаар тохируулна.

```
CN=1 bash <(curl -s https://ghproxy.com/https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

### Contabo IPV6-г идэвхжүүлдэг

IPV6-г идэвхжүүлснээр SMTP IPV6 хаягтай имэйл илгээх боломжтой.

засварлах `/etc/sysctl.conf`

Дараах мөрүүдийг өөрчлөх буюу нэмнэ үү

```
net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0
```

[Контабо зааварчилгааг дагана уу: Өөрийн серверт IPv6 холболт нэмэх](https://contabo.com/blog/adding-ipv6-connectivity-to-your-server/)

`/etc/netplan/01-netcfg.yaml` засварлаж, доорх зурагт үзүүлсэн шиг хэдэн мөр нэмнэ үү (Contabo VPS өгөгдмөл тохиргооны файлд аль хэдийн эдгээр мөрүүд байгаа тул тайлбарыг арилгана уу).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/5MEi41I.webp)

Дараа нь өөрчилсөн тохиргоог хүчин төгөлдөр болгохын тулд `netplan apply` .

Тохиргоо амжилттай болсны дараа та `curl 6.ipw.cn` ашиглан гадаад сүлжээнийхээ ipv6 хаягийг харж болно.

## Тохиргооны репозиторыг клон хийх

```
git clone https://github.com/wactax/ops.soft.git
```

## Домэйн нэрэндээ үнэгүй SSL сертификат үүсгээрэй

Имэйл илгээхэд шифрлэлт болон гарын үсэг зурахын тулд SSL сертификат шаардлагатай.

Бид гэрчилгээ үүсгэхийн тулд [acme.sh](https://github.com/acmesh-official/acme.sh) ашигладаг.

acme.sh нь нээлттэй эхийн автоматжуулсан гэрчилгээ гарын үсэг зурах хэрэгсэл юм.

ops.soft тохиргооны агуулахыг оруулаад `./ssl.sh` ажиллуулаад **дээд директорт** `conf` хавтас үүснэ.

[Acme.sh dnsapi-](https://github.com/acmesh-official/acme.sh/wiki/dnsapi) с DNS үйлчилгээ үзүүлэгчээ хайж олоод `conf/conf.sh` засварлана уу.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Qjq1C1i.webp)

Дараа нь `./ssl.sh 123.com` ажиллуулж өөрийн домэйн нэрэндээ `123.com` болон `*.123.com` сертификатуудыг үүсгэнэ.

Эхний гүйлт нь [acme.sh-г](https://github.com/acmesh-official/acme.sh) автоматаар суулгаж, автоматаар шинэчлэх хуваарьтай ажлыг нэмнэ. Та `crontab -l` харж болно, дараах байдлаар ийм мөр байна.

```
52 0 * * * "/mnt/www/.acme.sh"/acme.sh --cron --home "/mnt/www/.acme.sh" > /dev/null
```

Үүсгэсэн гэрчилгээний зам нь `/mnt/www/.acme.sh/123.com_ecc。`

Сертификатын сунгалт нь `conf/reload/123.com.sh` скриптийг дуудаж, энэ скриптийг засварлана, та холбогдох програмуудын гэрчилгээний кэшийг сэргээхийн тулд `nginx -s reload` гэх мэт тушаалуудыг нэмж болно.

## Chasquid-тэй SMTP серверийг бүтээх

[chasquid](https://github.com/albertito/chasquid) нь Go хэл дээр бичигдсэн нээлттэй эхийн SMTP сервер юм.

Postfix, Sendmail гэх мэт эртний шуудангийн серверийн программуудыг орлох тул chasquid нь илүү энгийн бөгөөд ашиглахад хялбар бөгөөд хоёрдогч хөгжүүлэлтэд ч хялбар байдаг.

`./chasquid/init.sh 123.com` нэг товшилтоор автоматаар сууна (123.com-г илгээж буй домэйн нэрээр солино уу).

## Имэйл гарын үсэг DKIM-г тохируулах

DKIM нь захидлыг спам гэж үзэхээс сэргийлэхийн тулд имэйлийн гарын үсэг илгээхэд ашиглагддаг.

Команд амжилттай ажилласны дараа DKIM бичлэгийг тохируулахыг танаас хүсэх болно (доор үзүүлсэн шиг).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/LJWGsmI.webp)

Зүгээр л DNS-дээ TXT бичлэг нэмнэ (доор үзүүлсэн шиг).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/0szKWqV.webp)

## Үйлчилгээний статус, бүртгэлийг харах

 `systemctl status chasquid` Үйлчилгээний статусыг харах.

Хэвийн ажиллагааны төлөвийг доорх зурагт үзүүлэв

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/CAwyY4E.webp)

 `grep chasquid /var/log/syslog` эсвэл `journalctl -xeu chasquid` алдааны бүртгэлийг харж болно.

## Урвуу домэйн нэрийн тохиргоо

Урвуу домэйн нэр нь IP хаягийг харгалзах домэйн нэрээр шийдвэрлэх боломжийг олгох явдал юм.

Урвуу домэйн нэрийг тохируулах нь имэйлийг спам гэж тодорхойлохоос сэргийлж чадна.

Имэйлийг хүлээн авах үед хүлээн авагч сервер нь илгээгч серверийн урвуу домэйн нэртэй эсэхийг баталгаажуулахын тулд илгээгч серверийн IP хаяг дээр урвуу домэйн нэрний шинжилгээ хийнэ.

Хэрэв илгээгч сервер урвуу домэйн нэргүй эсвэл урвуу домэйн нэр нь илгээгч серверийн IP хаягтай таарахгүй бол хүлээн авагч сервер имэйлийг спам гэж хүлээн зөвшөөрөх эсвэл татгалзах боломжтой.

[https://my.contabo.com/rdns](https://my.contabo.com/rdns) руу зочилж, доор үзүүлсэн шиг тохируулна уу

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/IIPdBk_.webp)

Урвуу домэйн нэрийг тохируулсны дараа IPv4 болон ipv6 домэйн нэрийн сервер рүү дамжуулах нарийвчлалыг тохируулахаа бүү мартаарай.

## chasquid.conf-н хостын нэрийг засна уу

`conf/chasquid/chasquid.conf` урвуу домэйн нэрний утга болгон өөрчлөх.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/6Fw4SQi.webp)

Дараа нь үйлчилгээг дахин эхлүүлэхийн тулд `systemctl restart chasquid` ажиллуул.

## Conf-г git репозитор руу нөөцлөх

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Fier9uv.webp)

Жишээлбэл, би conf хавтсыг өөрийн github процесс руу дараах байдлаар нөөцлөнө

Эхлээд хувийн агуулах байгуул

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ZSCT1t1.webp)

conf лавлахыг оруулаад агуулахад илгээнэ үү

```
git init
git add .
git commit -m "init"
git branch -M main
git remote add origin git@github.com:wac-tax-key/conf.git
git push -u origin main
```

## Илгээгч нэмнэ үү

гүйх

```
chasquid-util user-add i@wac.tax
```

Илгээгч нэмж болно

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/khHjLof.webp)

### Нууц үг зөв тохируулагдсан эсэхийг шалгана уу

```
chasquid-util authenticate i@wac.tax --password=xxxxxxx
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/e92JHXq.webp)

Хэрэглэгчийг нэмсний дараа `chasquid/domains/wac.tax/users` шинэчлэгдэх тул агуулахад оруулахаа мартуузай.

## DNS нь SPF бичлэг нэмнэ

SPF (Sender Policy Framework) нь цахим шуудангаар залилан мэхлэхээс сэргийлэхэд ашигладаг цахим шуудангийн баталгаажуулалтын технологи юм.

Энэ нь илгээгчийн IP хаяг нь домэйн нэрний DNS бүртгэлтэй таарч байгаа эсэхийг шалгах замаар шуудан илгээгчийн таних эсэхийг шалгаж, залилан мэхлэгчдээс хуурамч имэйл илгээхээс сэргийлдэг.

SPF бүртгэл нэмэх нь имэйлийг спам гэж тодорхойлохоос аль болох сэргийлж чадна.

Хэрэв таны домэйн нэрийн сервер SPF төрлийг дэмждэггүй бол TXT төрлийн бичлэгийг нэмнэ үү.

Жишээлбэл, `wac.tax` -ийн SPF нь дараах байдалтай байна

`v=spf1 a mx include:_spf.wac.tax include:_spf.google.com ~all`

`_spf.wac.tax` -д зориулсан SPF

`v=spf1 a:smtp.wac.tax ~all`

Би энд `include:_spf.google.com` байгаа гэдгийг анхаарна уу, учир нь би `i@wac.tax` дараа нь Google шуудангийн хайрцагт илгээх хаяг болгон тохируулах болно.

## DNS тохиргоо DMARC

DMARC нь (Domain-based Message Authentication, Reporting & Conformance) гэсэн үгийн товчлол юм.

Энэ нь SPF-ийн уналтыг (магадгүй тохиргооны алдаанаас үүдэлтэй эсвэл өөр хэн нэгэн таныг спам илгээж байгаа мэт дүр эсгэж байгаа) авахын тулд ашиглагддаг.

TXT бичлэг нэмэх `_dmarc` ,

Агуулга нь дараах байдалтай байна

```
v=DMARC1; p=quarantine; fo=1; ruf=mailto:ruf@wac.tax; rua=mailto:rua@wac.tax
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/k44P7O3.webp)

Параметр бүрийн утга нь дараах байдалтай байна

### p (Бодлого)

SPF (Илгээгчийн бодлогын хүрээ) эсвэл DKIM (DomainKeys Identified Mail) баталгаажуулалтад амжилтгүй болсон имэйлийг хэрхэн зохицуулахыг заана. p параметрийг гурван утгын аль нэгэнд тохируулж болно:

* байхгүй: Ямар ч арга хэмжээ авахгүй, зөвхөн баталгаажуулалтын үр дүнг имэйлээр мэдээлэх механизмаар дамжуулан илгээгчид буцааж өгдөг.
* Хорио цээр: Баталгаажуулаагүй имэйлийг спам хавтсанд хийнэ, гэхдээ шууд татгалзахгүй.
* татгалзах: Баталгаажуулж чадаагүй имэйлийг шууд үгүйсгэх.

### fo (Алдаа гарах сонголтууд)

Мэдээллийн механизмын буцаасан мэдээллийн хэмжээг зааж өгнө. Үүнийг дараах утгуудын аль нэгэнд тохируулж болно.

* 0: Бүх мессежийн баталгаажуулалтын үр дүнг мэдээлэх
* 1: Зөвхөн баталгаажуулалт амжилтгүй болсон мессежийг мэдээлнэ үү
* d: Зөвхөн домэйн нэрийг баталгаажуулах алдааг мэдээлэх
* s: зөвхөн SPF баталгаажуулалтын алдааг мэдээлнэ
* л: Зөвхөн DKIM баталгаажуулалтын алдааг мэдээлнэ үү

### rua & ruf

* rua (Нэгдсэн тайлангийн тайлагнах URI): Нэгдсэн тайланг хүлээн авах имэйл хаяг
* ruf (Шүүхийн шинжилгээний тайлангийн URI тайлан): дэлгэрэнгүй тайланг хүлээн авах имэйл хаяг

## Google Mail руу имэйл дамжуулахын тулд MX бичлэгүүдийг нэмнэ үү

Би бүх нийтийн хаягийг дэмждэг (Catch-All, энэ домэйн нэр рүү илгээсэн аливаа имэйлийг угтварт хязгаарлалтгүйгээр хүлээн авах боломжтой) үнэ төлбөргүй байгууллагын шуудангийн хайрцгийг олж чадаагүй тул би бүх имэйлийг Gmail шуудангийн хайрцаг руугаа дамжуулахдаа chasquid ашигласан.

**Хэрэв та өөрийн төлбөртэй бизнесийн шуудангийн хайрцагтай бол MX-г бүү өөрчил, энэ алхмыг алгасана уу.**

`conf/chasquid/domains/wac.tax/aliases` засварлах, дамжуулах шуудангийн хайрцгийг тохируулах

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/OBDl2gw.webp)

`*` бүх имэйлийг заана, `i` нь дээр үүсгэсэн илгээгч хэрэглэгчийн имэйл хаягийн угтвар юм. Захиа дамжуулахын тулд хэрэглэгч бүр мөр нэмэх шаардлагатай.

Дараа нь MX бичлэгийг нэмнэ үү (доорх зурган дээрх эхний мөрөнд үзүүлсэн шиг урвуу домэйн нэрний хаяг руу шууд зааж өгнө).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/7__KrU8.webp)

Тохиргоог хийж дууссаны дараа та өөр имэйл хаягийг ашиглан `i@wac.tax` болон `any123@wac.tax` руу имэйл илгээж, Gmail дээр имэйл хүлээн авах боломжтой эсэхийг харах боломжтой.

Хэрэв үгүй ​​бол chasquid бүртгэлийг шалгана уу ( `grep chasquid /var/log/syslog` ).

## Google Mail ашиглан i@wac.tax руу имэйл илгээнэ үү

Google Mail шуудан хүлээн авсны дараа би мэдээж i.wac.tax@gmail.com биш `i@wac.tax` гэж хариулна гэж найдаж байсан.

[https://mail.google.com/mail/u/1/#settings/accounts](https://mail.google.com/mail/u/1/#settings/accounts) руу орж "Өөр имэйл хаяг нэмэх" дээр дарна уу.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/PAvyE3C.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/_OgLsPT.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/XIUf6Dc.webp)

Дараа нь илгээсэн цахим шуудангаар хүлээн авсан баталгаажуулах кодыг оруулна уу.

Эцэст нь үүнийг анхдагч илгээгчийн хаягаар тохируулж болно (ижил хаягаар хариу бичих сонголттой хамт).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/a95dO60.webp)

Ийм байдлаар бид SMTP мэйл серверийг байгуулж дуусч, нэгэн зэрэг Google Mail ашиглан имэйл илгээх, хүлээн авах боломжтой боллоо.

## Тохиргоо амжилттай хийгдсэн эсэхийг шалгахын тулд тестийн имэйл илгээнэ үү

`ops/chasquid` оруулна уу

`direnv allow` (direnv нь өмнөх нэг товчлууртай эхлүүлэх процесст суулгагдсан бөгөөд бүрхүүлд дэгээ нэмэгдсэн)

дараа нь гүй

```
user=i@wac.tax pass=xxxx to=iuser.link@gmail.com ./sendmail.coffee
```

Параметрүүдийн утга нь дараах байдалтай байна

* хэрэглэгч: SMTP хэрэглэгчийн нэр
* нэвтрүүлэх: SMTP нууц үг
* руу: хүлээн авагч

Та туршилтын имэйл илгээж болно.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ae1iWyM.webp)

Тохиргоо амжилттай хийгдсэн эсэхийг шалгахын тулд туршилтын имэйл хүлээн авахын тулд Gmail ашиглахыг зөвлөж байна.

### TLS стандарт шифрлэлт

Доорх зурагт үзүүлсэн шиг ийм жижиг түгжээ байгаа нь SSL сертификат амжилттай идэвхжсэн гэсэн үг.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/SrdbAwh.webp)

Дараа нь "Эх имэйлийг харуулах" дээр дарна уу.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/qQQsdxg.webp)

### DKIM

Доорх зурагт үзүүлснээр Gmail-ийн анхны имэйл хуудас DKIM-г харуулсан бөгөөд энэ нь DKIM-ийн тохиргоо амжилттай болсон гэсэн үг юм.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/an6aXK6.webp)

Анхны имэйлийн толгой хэсэгт Хүлээн авсан хэсгийг шалгаад илгээгчийн хаяг нь IPV6 байгаа нь IPV6-г амжилттай тохируулсан гэсэн үг юм.
